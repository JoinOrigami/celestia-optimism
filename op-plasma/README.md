# Plasma x Celestia:

## Overview:

This repo implements a celestia `da-server` for plasma mode using generic commitments.

The `da-server` connects to a celestia-node running as a sidecar process.

celestia da-server accepts the following flags for celestia storage using
[celestia-openrpc](https://github.com/celestiaorg/celestia-openrpc)

````
    --celestia.auth-token value                                            ($OP_PLASMA_DA_SERVER_CELESTIA_AUTH_TOKEN)
          celestia auth token

    --celestia.namespace value                                             ($OP_PLASMA_DA_SERVER_CELESTIA_NAMESPACE)
          celestia namespace

    --celestia.server value                                                ($OP_PLASMA_DA_SERVER_CELESTIA_SERVER)
          celestia server endpoint
````

The celestia server endpoint should be set to the celestia-node rpc server, usually `http://127.0.0.1:26658`.

A random valid namespace can be generated by running the following command:

```sh
export NAMESPACE=00000000000000000000000000000000000000$(openssl rand -hex 10)
```

The auth token is auto generated and is required to submit blob transactions to the
celestia-node.

## Testing:

Follow the usual instructions for setting up bedrock devnet.

The following instructions are for testing the `da-server` in celestia devnet and testnet modes.

### Devnet:

For testing devnet, we'll use the local-celestia-devnet docker image which
simulates the whole celestia network including a local celestia-node and does
not require a peer-to-peer connection.

To run a local devnet with local-celestia-devnet:

```sh
DEVNET_PLASMA="true" GENERIC_PLASMA="true"  make devnet-up
```

This will start the bedrock devnet in plasma mode with local-celestia-devnet.

You can verify that the devnet is running by checking da-server logs:

```sh
docker logs -f ops-bedrock-da-server-1 | grep celestia
```

Upon successful operation, the logs should contain the following message:

```sh
t=2024-05-30T19:08:30+0000 lvl=info msg="Using celestia storage" url=http://da:26658
t=2024-05-30T19:08:32+0000 lvl=info msg="celestia: blob successfully submitted" id=0900000000000000b25a32154ab00902cfc0269b3239b612ebfe7f7263545119ee7251cc72728142
t=2024-05-30T19:08:34+0000 lvl=info msg="celestia: blob successfully submitted" id=0a00000000000000cb559bc3c6a01b0819460ce86c13165fdc58ac9c81c1e52404f8c4b36097db87
t=2024-05-30T19:08:34+0000 lvl=info msg="celestia: blob request" id=010c0900000000000000b25a32154ab00902cfc0269b3239b612ebfe7f7263545119ee7251cc72728142
```

### Testnet:

Usually, it's better to deploy both OP stack and celestia-node in the same
network, but for ease of testing, we will modify the devnet docker-compose
file to submit to celestia testnet instead.

For running plasma in celestia testnet mode, we'll use the celestia-node docker image which requires
a [celestia testnet network like mocha or arabica](https://docs.celestia.org/nodes/participate).

To run a celestia-node in testnet mode,
[follow the instructions for docker changes](https://docs.celestia.org/developers/optimism#docker-changes)

Note that in this case, the auth token needs to be configured using the CELESTIA_NODE_AUTH_TOKEN environment variable.

To obtain the auth token for celestia-node,
check [the documentation for the node type you are using](https://docs.celestia.org/developers/node-tutorial#auth-token):

Once the docker compose file is modified, you can run the devnet with the following command:

```sh
DEVNET_PLASMA="true" GENERIC_PLASMA="true"  make devnet-up
```

This will start the bedrock devnet in plasma mode with celestia-node running in testnet mode.

You can verify that the devnet is running by checking da-server logs:

```sh
docker logs -f ops-bedrock-da-server-1 | grep celestia
```

Once again, upon successful operation, the logs should contain the following message:

```sh
t=2024-05-30T19:08:30+0000 lvl=info msg="Using celestia storage" url=http://da:26658
t=2024-05-30T19:08:32+0000 lvl=info msg="celestia: blob successfully submitted" id=0900000000000000b25a32154ab00902cfc0269b3239b612ebfe7f7263545119ee7251cc72728142
t=2024-05-30T19:08:34+0000 lvl=info msg="celestia: blob successfully submitted" id=0a00000000000000cb559bc3c6a01b0819460ce86c13165fdc58ac9c81c1e52404f8c4b36097db87
t=2024-05-30T19:08:34+0000 lvl=info msg="celestia: blob request" id=010c0900000000000000b25a32154ab00902cfc0269b3239b612ebfe7f7263545119ee7251cc72728142
```
